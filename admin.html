<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FASK | Painel de Administração</title>
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8FAFC; /* Slate-50 */
        }
        /* Cor de destaque da marca: Âmbar/Dourado */
        .fask-accent-bg {
            background-color: #FBBF24; /* amber-400 */
        }
        .fask-accent-text {
            color: #FBBF24;
        }
        /* Cor primária: Azul Marinho Forte */
        .fask-primary-bg {
            background-color: #1E3A8A; /* blue-800 */
        }
        .fask-primary-text {
            color: #1E3A8A;
        }
        /* Estilo do Modal de Mensagem */
        .modal-overlay {
            background-color: rgba(30, 58, 138, 0.75); /* blue-900 com transparência */
        }
        /* Estilizando o botão "Remover" para destaque de ação perigosa */
        .btn-delete:hover {
            background-color: #DC2626; /* red-600 */
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">
    
    <div class="container mx-auto max-w-7xl bg-white p-6 sm:p-10 rounded-xl shadow-2xl border-t-8 border-amber-400">
        
        <header class="mb-10 border-b pb-4">
            <h1 class="text-4xl font-extrabold text-gray-900 fask-primary-text">FASK <span class="fask-accent-text">ADMIN</span></h1>
            <p class="text-gray-500 mt-1">Gerencie seu portfólio de imóveis de alto padrão.</p>
        </header>

        <!-- Formulário para Adicionar/Editar Imóveis -->
        <div id="form-container" class="mb-12 p-6 bg-gray-50 rounded-lg shadow-inner border border-gray-200">
            <h2 id="form-title" class="text-2xl font-bold mb-4 text-gray-800">Adicionar Novo Imóvel</h2>
            <form id="imovel-form" class="space-y-4 md:grid md:grid-cols-2 md:gap-4">
                
                <div class="col-span-full">
                    <label for="endereco" class="block text-sm font-medium text-gray-700">Endereço Completo:</label>
                    <input type="text" id="endereco" required 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-blue-500 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="proprietario" class="block text-sm font-medium text-gray-700">Proprietário/Contato:</label>
                    <input type="text" id="proprietario" required 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-blue-500 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="valor" class="block text-sm font-medium text-gray-700">Valor (R$):</label>
                    <input type="number" id="valor" required min="0" step="100" placeholder="Ex: 5500.00"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-blue-500 focus:ring-blue-500">
                </div>

                <div>
                    <label for="entrada" class="block text-sm font-medium text-gray-700">Data de Entrada no Portfólio:</label>
                    <input type="date" id="entrada" 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-blue-500 focus:ring-blue-500">
                </div>
                
                <div class="col-span-full">
                    <label for="descricao" class="block text-sm font-medium text-gray-700">Descrição (Detalhes de Luxo - 2 quartos, piscina, etc.):</label>
                    <textarea id="descricao" rows="4" 
                              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 focus:border-blue-500 focus:ring-blue-500"
                              placeholder="Apartamento 3 quartos (1 suíte), 2 banheiros, 120m², vista panorâmica para o mar."></textarea>
                </div>

                <div class="col-span-full flex justify-end space-x-4">
                    <button type="button" id="cancel-edit-btn" class="hidden bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg hover:bg-gray-400 transition duration-300">
                        Cancelar Edição
                    </button>
                    <button type="submit" id="submit-btn" class="fask-primary-bg text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                        Salvar Imóvel
                    </button>
                </div>
            </form>
        </div>

        <!-- Lista de Imóveis (Tabela Responsiva) -->
        <div>
            <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b-2 border-amber-400 pb-2 inline-block">Portfólio Ativo</h2>
            
            <p id="loading-message" class="text-gray-500 text-center py-10">
                <svg class="animate-spin h-5 w-5 mr-3 inline text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                Carregando imóveis do servidor...
            </p>
            
            <div id="imoveis-list" class="space-y-4">
                <!-- Imóveis serão injetados aqui -->
            </div>

            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-4" role="alert">
                <strong class="font-bold">Erro de Conexão!</strong>
                <span class="block sm:inline"> Não foi possível conectar ao servidor. Verifique se o `server.py` está rodando em `http://127.0.0.1:5000`.</span>
            </div>
        </div>
    </div>
    
    <!-- Modal de Mensagem (Sucesso, Erro, Confirmação) -->
    <div id="message-modal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center transform transition-transform duration-300 scale-95 opacity-0" id="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-2 fask-primary-text"></h3>
            <p id="modal-message" class="text-gray-700 mb-4"></p>
            <div id="modal-actions" class="flex justify-center space-x-4">
                <button id="modal-close" class="bg-gray-400 text-white py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-300">Fechar</button>
                <button id="modal-confirm" class="hidden bg-red-500 text-white py-2 px-4 rounded-lg btn-delete transition duration-300">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Lógica JavaScript -->
    <script>
        const API_URL = "http://127.0.0.1:5000/imoveis";

        const form = document.getElementById('imovel-form');
        const imoveisList = document.getElementById('imoveis-list');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');

        const modal = document.getElementById('message-modal');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close');
        const modalConfirmBtn = document.getElementById('modal-confirm');

        let isEditing = false;
        let imovelIdToEdit = null;
        let deleteCallback = null; // Função para armazenar a ação de confirmação de exclusão

        // ------------------ FUNÇÕES DE MODAL ------------------

        /**
         * Exibe o modal de mensagem (Sucesso, Erro ou Confirmação).
         * @param {string} title - Título do modal.
         * @param {string} message - Mensagem do modal.
         * @param {boolean} isConfirmation - Se é um modal de confirmação.
         * @param {Function} confirmAction - Ação a ser executada se confirmar (somente para confirmação).
         */
        function showMessageModal(title, message, isConfirmation = false, confirmAction = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            
            // Reseta botões
            modalConfirmBtn.classList.add('hidden');
            modalCloseBtn.textContent = isConfirmation ? 'Cancelar' : 'Fechar';
            
            // Configura para Confirmação
            if (isConfirmation) {
                modalConfirmBtn.classList.remove('hidden');
                deleteCallback = confirmAction;
            } else {
                deleteCallback = null;
            }

            // Exibe o Modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // Animação de entrada
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // Listener para fechar o modal
        modalCloseBtn.addEventListener('click', () => {
            closeModal();
        });
        
        // Listener para confirmação (Excluir)
        modalConfirmBtn.addEventListener('click', () => {
            if (deleteCallback) {
                deleteCallback();
            }
            closeModal();
        });
        
        function closeModal() {
             // Animação de saída
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
            }, 300);
        }

        // ------------------ CRUD ACTIONS ------------------

        /**
         * Renderiza um item de imóvel na lista.
         * @param {Object} imovel - Objeto do imóvel.
         */
        function renderImovelItem(imovel) {
            const item = document.createElement('div');
            item.className = 'bg-white p-4 rounded-lg shadow-md border-l-4 border-blue-500 flex flex-col md:flex-row justify-between items-start md:items-center space-y-3 md:space-y-0';
            
            const valorFormatado = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(imovel.valor);

            item.innerHTML = `
                <div class="flex-1 w-full md:w-auto overflow-hidden">
                    <p class="text-lg font-semibold text-gray-900 line-clamp-1">${imovel.endereco}</p>
                    <p class="text-sm text-gray-500">Proprietário: ${imovel.proprietario}</p>
                    <p class="text-md fask-accent-text font-bold mt-1">${valorFormatado} &mdash; ID: ${imovel.id}</p>
                    <p class="text-xs text-gray-400 mt-1 line-clamp-2">${imovel.descricao || 'N/A'}</p>
                </div>
                
                <div class="flex space-x-3 mt-3 md:mt-0">
                    <button onclick="handleEdit(${imovel.id})" class="bg-blue-600 text-white py-2 px-4 rounded-lg text-sm hover:bg-blue-700 transition duration-300 shadow-md">
                        Editar
                    </button>
                    <button onclick="handleDeleteClick(${imovel.id})" class="bg-red-500 text-white py-2 px-4 rounded-lg text-sm btn-delete transition duration-300 shadow-md">
                        Remover
                    </button>
                </div>
            `;
            imoveisList.appendChild(item);
        }

        /**
         * Busca e exibe todos os imóveis da API.
         */
        async function fetchImoveis() {
            loadingMessage.classList.remove('hidden');
            imoveisList.innerHTML = '';
            errorMessage.classList.add('hidden');
            
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Erro ao buscar os dados.');
                
                const imoveis = await response.json();
                
                if (imoveis.length === 0) {
                    imoveisList.innerHTML = '<p class="text-center py-8 text-gray-500">Nenhum imóvel cadastrado. Comece adicionando um novo imóvel acima.</p>';
                } else {
                    // Ordena por ID decrescente para mostrar os mais novos primeiro
                    imoveis.sort((a, b) => b.id - a.id); 
                    imoveis.forEach(renderImovelItem);
                }
                
                errorMessage.classList.add('hidden');
            } catch (error) {
                console.error("Erro ao buscar os imóveis:", error);
                errorMessage.classList.remove('hidden');
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        /**
         * Lida com a submissão do formulário (Adicionar ou Editar).
         */
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const imovelData = {
                endereco: document.getElementById('endereco').value,
                proprietario: document.getElementById('proprietario').value,
                valor: document.getElementById('valor').value,
                entrada: document.getElementById('entrada').value,
                descricao: document.getElementById('descricao').value,
            };

            try {
                let response;
                let method;
                let url;
                let successMessage;

                if (isEditing) {
                    // MODO EDIÇÃO (PUT)
                    method = 'PUT';
                    url = `${API_URL}/${imovelIdToEdit}`;
                    successMessage = 'Imóvel atualizado com sucesso!';
                } else {
                    // MODO ADIÇÃO (POST)
                    method = 'POST';
                    url = API_URL;
                    successMessage = 'Novo imóvel adicionado ao portfólio!';
                }

                response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(imovelData)
                });

                if (!response.ok) throw new Error(`Erro ${response.status} na API.`);

                await response.json(); 
                showMessageModal("Sucesso", successMessage);
                
                // Resetar após sucesso
                resetForm();
                fetchImoveis();

            } catch (error) {
                console.error("Erro na operação:", error);
                showMessageModal("Erro", `Não foi possível completar a operação. Detalhe: ${error.message}`);
            }
        });

        /**
         * Prepara o formulário para editar um imóvel.
         * @param {number} id - ID do imóvel a ser editado.
         */
        async function handleEdit(id) {
            try {
                const response = await fetch(API_URL);
                const allImoveis = await response.json();
                const imovel = allImoveis.find(i => i.id === id);

                if (imovel) {
                    document.getElementById('endereco').value = imovel.endereco || '';
                    document.getElementById('proprietario').value = imovel.proprietario || '';
                    document.getElementById('entrada').value = imovel.entrada || '';
                    document.getElementById('valor').value = imovel.valor || '';
                    document.getElementById('descricao').value = imovel.descricao || '';
                    
                    isEditing = true;
                    imovelIdToEdit = id;
                    
                    // Atualiza UI para Edição
                    formTitle.textContent = `Editar Imóvel (ID: ${id})`;
                    submitBtn.textContent = 'Atualizar Imóvel';
                    submitBtn.classList.add('bg-amber-500', 'hover:bg-amber-600');
                    submitBtn.classList.remove('fask-primary-bg', 'hover:bg-blue-700');
                    cancelEditBtn.classList.remove('hidden');
                    
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                console.error("Erro ao carregar dados para edição:", error);
                showMessageModal("Erro", "Não foi possível carregar os dados do imóvel.");
            }
        }

        /**
         * Inicia o fluxo de exclusão, exibindo o modal de confirmação.
         * @param {number} id - ID do imóvel a ser excluído.
         */
        function handleDeleteClick(id) {
            const confirmAction = () => removerImovel(id);
            showMessageModal(
                "Confirmação Necessária", 
                `Tem certeza que deseja remover o Imóvel ID ${id}? Esta ação é irreversível.`, 
                true, // É confirmação
                confirmAction // Função a executar se confirmado
            );
        }

        /**
         * Função principal para remover o imóvel (chamada após confirmação).
         * @param {number} id - ID do imóvel a ser removido.
         */
        async function removerImovel(id) {
            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error(`Erro ${response.status} na API.`);

                showMessageModal("Sucesso", "Imóvel removido com sucesso!");
                fetchImoveis();
            } catch (error) {
                console.error("Erro na remoção:", error);
                showMessageModal("Erro", `Não foi possível remover o imóvel. Detalhe: ${error.message}`);
            }
        }
        
        /**
         * Reseta o formulário e o estado de edição.
         */
        function resetForm() {
            form.reset();
            isEditing = false;
            imovelIdToEdit = null;
            
            // Atualiza UI para Adição
            formTitle.textContent = 'Adicionar Novo Imóvel';
            submitBtn.textContent = 'Salvar Imóvel';
            submitBtn.classList.remove('bg-amber-500', 'hover:bg-amber-600');
            submitBtn.classList.add('fask-primary-bg', 'hover:bg-blue-700');
            cancelEditBtn.classList.add('hidden');
        }

        // Listener para Cancelar Edição
        cancelEditBtn.addEventListener('click', resetForm);

        // Carrega os imóveis ao carregar a página
        window.onload = fetchImoveis;
    </script>
</body>
</html>
